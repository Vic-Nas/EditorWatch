<!DOCTYPE html>
<html>
<head>
    <title>EditorWatch - Dashboard</title>
    <link rel="icon" href="/extension/icon.png" type="image/png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f7fa;
        }
        .header {
            background: white;
            padding: 20px 40px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 24px; color: #333; }
        .header a { color: #667eea; text-decoration: none; }
        .container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
        .section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .section h2 { margin-bottom: 20px; color: #333; }
        .btn {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
        }
        .btn:hover { background: #5568d3; }
        .btn-small { padding: 5px 10px; font-size: 12px; }
        .btn-secondary { background: #48bb78; }
        .btn-secondary:hover { background: #38a169; }
        .btn-danger { background: #e74c3c; }
        .btn-danger:hover { background: #c0392b; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; color: #333; }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal input, .modal select, .modal textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: inherit;
        }
        .modal textarea { min-height: 150px; font-size: 13px; font-family: monospace; }
        .close {
            float: right;
            cursor: pointer;
            font-size: 24px;
            color: #999;
        }
        .success-box {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .status-clean { color: #2ecc71; font-weight: bold; }
        .status-warning { color: #f39c12; font-weight: bold; }
        .status-suspicious { color: #e74c3c; font-weight: bold; }
        .status-pending { color: #95a5a6; font-weight: bold; }
        .help-text { font-size: 12px; color: #666; margin-top: 5px; }
        .pattern-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 10px 0;
        }
        .chip {
            background: #e0e7ff;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .chip .remove {
            cursor: pointer;
            color: #667eea;
            font-weight: bold;
        }
        .add-pattern {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .add-pattern input {
            flex: 1;
            margin: 0;
        }
        .add-pattern button {
            margin: 0;
            padding: 10px 16px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>EditorWatch Dashboard</h1>
        <a href="/logout">Logout</a>
    </div>
    
    <div class="container">
        <div class="section">
            <h2>Assignments</h2>
            <button class="btn" onclick="showCreateModal()">+ Create Assignment</button>
            <div id="assignments-list"><p>Loading...</p></div>
        </div>
        
        <div class="section" id="submissions-section" style="display: none;">
            <h2>Submissions</h2>
            <div id="submissions-list"></div>
        </div>
    </div>
    
    <div id="createModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="hideCreateModal()">&times;</span>
            <h2>Create Assignment</h2>
            <form id="createForm" onsubmit="createAssignment(event)">
                <input type="text" id="name" placeholder="Assignment Name" required>
                <input type="text" id="course" placeholder="Course" required>
                <input type="datetime-local" id="deadline" required>
                
                <label><strong>Track Patterns:</strong></label>
                <div class="help-text">File patterns to monitor (e.g., *.py, *.js)</div>
                <div id="pattern-chips" class="pattern-chips"></div>
                <div class="add-pattern">
                    <input type="text" id="new-pattern" placeholder="e.g., *.ts">
                    <button type="button" class="btn btn-small" onclick="addPattern()">Add</button>
                </div>
                
                <label><strong>Students:</strong></label>
                <div class="help-text">Format: email,First Name,Last Name (one per line)</div>
                <textarea id="students" placeholder="alice@uni.edu,Alice,Johnson
bob@uni.edu,Bob,Smith
charlie@uni.edu,Charlie,Brown"></textarea>
                
                <button type="submit" class="btn" style="margin-top: 10px;">Create Assignment</button>
            </form>
            
            <div id="result-message" style="display: none;"></div>
        </div>
    </div>
    
    <script>
        var patterns = ['*.py', '*.js'];
        
        function renderPatterns() {
            var container = document.getElementById('pattern-chips');
            container.innerHTML = patterns.map(function(p, i) {
                return '<div class="chip">' + p + 
                       '<span class="remove" onclick="removePattern(' + i + ')">√ó</span></div>';
            }).join('');
        }
        
        function addPattern() {
            var input = document.getElementById('new-pattern');
            var pattern = input.value.trim();
            if (pattern && !patterns.includes(pattern)) {
                patterns.push(pattern);
                renderPatterns();
                input.value = '';
            }
        }
        
        function removePattern(index) {
            patterns.splice(index, 1);
            renderPatterns();
        }
        
        function parseStudents() {
            var text = document.getElementById('students').value;
            var lines = text.split('\n').map(function(l) { return l.trim(); }).filter(function(l) { return l; });
            
            return lines.map(function(line) {
                var parts = line.split(',').map(function(s) { return s.trim(); });
                if (parts.length >= 1) {
                    return {
                        email: parts[0],
                        first_name: parts[1] || '',
                        last_name: parts[2] || ''
                    };
                }
                return null;
            }).filter(function(s) { return s && s.email; });
        }
        
        function loadAssignments() {
            fetch('/api/assignments')
                .then(function(r) { return r.json(); })
                .then(function(assignments) {
                    var html = assignments.length ? 
                        '<table><tr><th>Course</th><th>Assignment</th><th>Deadline</th><th>Submissions</th><th>Actions</th></tr>' +
                        assignments.map(function(a) {
                            return '<tr>' +
                                '<td>' + a.course + '</td>' +
                                '<td>' + a.name + '</td>' +
                                '<td>' + new Date(a.deadline).toLocaleString() + '</td>' +
                                '<td>' + a.submitted_count + '/' + a.total_students + '</td>' +
                                '<td>' +
                                '<a href="/api/assignments/' + a.assignment_id + '/config" class="btn btn-small btn-secondary" download>‚¨á Config</a> ' +
                                '<a href="/api/assignments/' + a.assignment_id + '/codes.csv" class="btn btn-small btn-secondary" download>üìã Codes CSV</a> ' +
                                '<a href="/assignments/' + a.assignment_id + '/mailtos" class="btn btn-small" target="_blank">‚úâÔ∏è Mail Composer</a> ' +
                                '<button class="btn btn-small" onclick="viewSubmissions(\'' + a.assignment_id + '\')">View</button> ' +
                                '<a href="/assignments/' + a.assignment_id + '/graph" class="btn btn-small" target="_blank">Graph</a> ' +
                                '<button class="btn btn-small btn-danger" onclick="deleteAssignment(\'' + a.assignment_id + '\')">Delete</button>' +
                                '</td></tr>';
                        }).join('') + '</table>'
                        : '<p style="margin-top: 20px;">No assignments yet.</p>';
                    
                    document.getElementById('assignments-list').innerHTML = html;
                });
        }
        
        function viewSubmissions(assignmentId) {
            fetch('/api/assignments/' + assignmentId + '/submissions')
                .then(function(r) { return r.json(); })
                .then(function(submissions) {
                    var section = document.getElementById('submissions-section');
                    section.style.display = 'block';
                    
                    var labels = {
                        'clean': 'üü¢ Clean',
                        'warning': 'üü° Review',
                        'suspicious': 'üî¥ Suspicious',
                        'pending': '‚è≥ Pending'
                    };
                    
                    var html = submissions.length ? 
                        '<h3>Assignment: ' + assignmentId + '</h3>' +
                        '<table><tr><th>Student</th><th>Submitted</th><th>Score</th><th>Status</th><th>Actions</th></tr>' +
                        submissions.map(function(s) {
                            var scoreText = s.overall_score !== null ? s.overall_score.toFixed(1) + '/10' : '-';
                            return '<tr>' +
                                '<td>' + (s.student_name || s.email) + '</td>' +
                                '<td>' + new Date(s.submitted_at).toLocaleString() + '</td>' +
                                '<td>' + scoreText + '</td>' +
                                '<td><span class="status-' + s.status + '">' + labels[s.status] + '</span></td>' +
                                '<td>' +
                                '<a href="/submission/' + s.id + '" class="btn btn-small">Detail</a> ' +
                                '<a href="/api/submissions/' + s.id + '/export" class="btn btn-small btn-secondary" download>üì• Export</a>' +
                                '</td></tr>';
                        }).join('') + '</table>'
                        : '<p>No submissions yet.</p>';
                    
                    document.getElementById('submissions-list').innerHTML = html;
                    section.scrollIntoView({ behavior: 'smooth' });
                });
        }
        
        function showCreateModal() {
            document.getElementById('createModal').style.display = 'flex';
            document.getElementById('result-message').style.display = 'none';
            patterns = ['*.py', '*.js'];
            renderPatterns();
        }
        
        function hideCreateModal() {
            document.getElementById('createModal').style.display = 'none';
            document.getElementById('createForm').reset();
        }
        
        function createAssignment(event) {
            event.preventDefault();
            
            var students = parseStudents();
            if (students.length === 0) {
                alert('Please enter at least one student');
                return;
            }
            
            var data = {
                name: document.getElementById('name').value,
                course: document.getElementById('course').value,
                deadline: document.getElementById('deadline').value,
                track_patterns: patterns,
                students: students
            };
            
            fetch('/api/assignments', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(function(r) { return r.json(); })
            .then(function(result) {
                var msg = document.getElementById('result-message');
                
                var html = '<div class="success-box">' +
                    '<strong>‚úÖ Assignment created!</strong><br>' +
                    '<p>Generated codes for ' + result.students.length + ' student(s)</p>';
                
                if (result.smtp_enabled) {
                    html += '<p>Emails sent: ' + result.codes_sent + '/' + result.students.length + '</p>';
                } else {
                    html += '<div class="warning-box" style="margin-top: 10px;">' +
                        '<strong>‚ö†Ô∏è SMTP not configured</strong><br>' +
                        'Download the codes CSV to share with students.' +
                        '</div>';
                }
                
                html += '<a href="' + result.config_url + '" class="btn btn-secondary" download style="margin-top: 10px; margin-right: 10px;">' +
                    'üì• Download Config' +
                    '</a>';
                
                html += '<a href="/api/assignments/' + result.assignment_id + '/codes.csv" class="btn btn-secondary" download style="margin-top: 10px;">' +
                    'üìã Download Codes CSV' +
                    '</a></div>';
                
                msg.innerHTML = html;
                msg.style.display = 'block';
                
                loadAssignments();
                document.getElementById('createForm').reset();
            })
            .catch(function(e) {
                alert('Error creating assignment');
                console.error(e);
            });
        }
        
        function deleteAssignment(assignmentId) {
            if (!confirm('Delete this assignment? All data will be lost!')) return;
            
            fetch('/api/assignments/' + assignmentId, { method: 'DELETE' })
                .then(function(r) {
                    if (r.ok) {
                        loadAssignments();
                        document.getElementById('submissions-section').style.display = 'none';
                    }
                });
        }
        
        renderPatterns();
        loadAssignments();
    </script>
</body>
</html>
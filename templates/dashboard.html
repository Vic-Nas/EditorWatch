<!DOCTYPE html>
<html>
<head>
    <title>EditorWatch - Dashboard</title>
    <link rel="icon" href="/extension/icon.png" type="image/png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f7fa;
        }
        .header {
            background: white;
            padding: 20px 40px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 24px; color: #333; }
        .header a { color: #667eea; text-decoration: none; }
        .container { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
        .section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .section h2 { margin-bottom: 20px; color: #333; }
        .btn {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
        }
        .btn:hover { background: #5568d3; }
        .btn-small { padding: 5px 10px; font-size: 12px; }
        .btn-secondary { background: #48bb78; }
        .btn-secondary:hover { background: #38a169; }
        .btn-danger { background: #e74c3c; }
        .btn-danger:hover { background: #c0392b; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; color: #333; }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal input, .modal select, .modal textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: inherit;
        }
        .modal textarea { min-height: 100px; font-size: 13px; }
        .close {
            float: right;
            cursor: pointer;
            font-size: 24px;
            color: #999;
        }
        .success-box {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .status-clean { color: #2ecc71; font-weight: bold; }
        .status-warning { color: #f39c12; font-weight: bold; }
        .status-suspicious { color: #e74c3c; font-weight: bold; }
        .status-pending { color: #95a5a6; font-weight: bold; }
        .help-text { font-size: 12px; color: #666; margin-top: 5px; }
        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            color: #666;
        }
        .tab.active { color: #667eea; border-bottom-color: #667eea; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .file-input-wrapper { position: relative; display: inline-block; }
        .file-input-label {
            display: inline-block;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }
        .file-input-label:hover { background: #5568d3; }
        input[type="file"] { position: absolute; left: -9999px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>EditorWatch Dashboard</h1>
        <a href="/logout">Logout</a>
    </div>
    
    <div class="container">
        <div class="section">
            <h2>Assignments</h2>
            <button class="btn" onclick="showCreateModal()">+ Create Assignment</button>
            <div id="assignments-list"><p>Loading...</p></div>
        </div>
        
        <div class="section" id="submissions-section" style="display: none;">
            <h2>Submissions</h2>
            <div id="submissions-list"></div>
        </div>
    </div>
    
    <div id="createModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="hideCreateModal()">&times;</span>
            <h2>Create Assignment</h2>
            <form id="createForm" onsubmit="createAssignment(event)">
                <input type="text" id="name" placeholder="Assignment Name" required>
                <input type="text" id="course" placeholder="Course" required>
                <input type="datetime-local" id="deadline" required>
                
                <label><strong>Track Patterns:</strong></label>
                <input type="text" id="track_patterns" placeholder="*.py, *.js" value="*.py">
                <div class="help-text">Comma-separated</div>
                
                <label><strong>Students:</strong></label>
                <div class="tab-container">
                    <div class="tab active" onclick="switchTab('manual')">Manual</div>
                    <div class="tab" onclick="switchTab('csv')">CSV Upload</div>
                    <div class="tab" onclick="switchTab('sheet')">Saved List</div>
                </div>
                
                <div id="tab-manual" class="tab-content active">
                    <textarea id="students-manual" placeholder="email,First Name,Last Name
alice@uni.edu,Alice,Johnson"></textarea>
                    <div class="help-text">Format: email,first_name,last_name</div>
                </div>
                
                <div id="tab-csv" class="tab-content">
                    <div class="file-input-wrapper">
                        <label class="file-input-label" for="csv-file">üìÑ Choose CSV</label>
                        <input type="file" id="csv-file" accept=".csv" onchange="handleCSV(event)">
                    </div>
                    <div id="csv-preview"></div>
                </div>
                
                <div id="tab-sheet" class="tab-content">
                    <select id="sheet-select">
                        <option value="">Select saved list...</option>
                    </select>
                    <div class="help-text">Or <a href="#" onclick="showSheetManager(); return false;">manage lists</a></div>
                </div>
                
                <button type="submit" class="btn" style="margin-top: 10px;">Create & Send Codes</button>
            </form>
            
            <div id="success-message" style="display: none;"></div>
        </div>
    </div>
    
    <script>
        var currentTab = 'manual';
        var csvData = null;
        var sheets = [];
        
        function switchTab(tab) {
            currentTab = tab;
            var tabs = document.querySelectorAll('.tab');
            var contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(function(t) { t.classList.remove('active'); });
            contents.forEach(function(t) { t.classList.remove('active'); });
            
            var activeTab = Array.from(tabs).find(function(t) { 
                return t.getAttribute('onclick').indexOf(tab) > -1; 
            });
            if (activeTab) activeTab.classList.add('active');
            
            var activeContent = document.getElementById('tab-' + tab);
            if (activeContent) activeContent.classList.add('active');
        }
        
        function loadSheets() {
            fetch('/api/sheets')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    sheets = data;
                    var select = document.getElementById('sheet-select');
                    select.innerHTML = '<option value="">Select saved list...</option>' +
                        sheets.map(function(s) { 
                            return '<option value="' + s.id + '">' + s.name + ' (' + s.student_count + ' students)</option>'; 
                        }).join('');
                })
                .catch(function(e) {
                    console.error('Failed to load sheets:', e);
                });
        }
        
        function handleCSV(event) {
            var file = event.target.files[0];
            if (!file) return;
            
            var reader = new FileReader();
            reader.onload = function(e) {
                var text = e.target.result;
                var lines = text.split('\n').map(function(l) { return l.trim(); }).filter(function(l) { return l; });
                
                csvData = lines.slice(1).map(function(line) {
                    var parts = line.split(',').map(function(s) { return s.trim(); });
                    return { 
                        email: parts[0], 
                        first_name: parts[1], 
                        last_name: parts[2] 
                    };
                }).filter(function(s) { return s.email; });
                
                document.getElementById('csv-preview').innerHTML = 
                    '<div class="success-box">‚úÖ Loaded ' + csvData.length + ' students</div>';
            };
            reader.readAsText(file);
        }
        
        function parseStudents() {
            if (currentTab === 'manual') {
                var text = document.getElementById('students-manual').value;
                var lines = text.split('\n').map(function(l) { return l.trim(); }).filter(function(l) { return l; });
                var start = lines[0] && lines[0].toLowerCase().indexOf('email') > -1 ? 1 : 0;
                
                return lines.slice(start).map(function(line) {
                    var parts = line.split(',').map(function(s) { return s.trim(); });
                    if (parts.length >= 3) {
                        return { 
                            email: parts[0], 
                            first_name: parts[1], 
                            last_name: parts[2] 
                        };
                    }
                    return null;
                }).filter(function(s) { return s && s.email; });
            } else if (currentTab === 'csv') {
                return csvData || [];
            } else if (currentTab === 'sheet') {
                var sheetId = document.getElementById('sheet-select').value;
                if (!sheetId) return [];
                var sheet = sheets.find(function(s) { return s.id == sheetId; });
                return sheet ? JSON.parse(sheet.students) : [];
            }
            return [];
        }
        
        function loadAssignments() {
            fetch('/api/assignments')
                .then(function(response) { return response.json(); })
                .then(function(assignments) {
                    var html = assignments.length ? 
                        '<table><tr><th>Course</th><th>Assignment</th><th>Deadline</th><th>Actions</th></tr>' +
                        assignments.map(function(a) {
                            return '<tr>' +
                                '<td>' + a.course + '</td>' +
                                '<td>' + a.name + '</td>' +
                                '<td>' + new Date(a.deadline).toLocaleString() + '</td>' +
                                '<td>' +
                                '<a href="/api/assignments/' + a.assignment_id + '/config" class="btn btn-small btn-secondary" download>‚¨á Config</a> ' +
                                '<button class="btn btn-small" onclick="viewSubmissions(\'' + a.assignment_id + '\')">View</button> ' +
                                '<button class="btn btn-small btn-danger" onclick="deleteAssignment(\'' + a.assignment_id + '\')">Delete</button>' +
                                '</td></tr>';
                        }).join('') + '</table>'
                        : '<p style="margin-top: 20px;">No assignments yet.</p>';
                    
                    document.getElementById('assignments-list').innerHTML = html;
                })
                .catch(function(e) {
                    console.error('Error loading assignments:', e);
                    document.getElementById('assignments-list').innerHTML = '<p style="color: red;">Error loading assignments</p>';
                });
        }
        
        function viewSubmissions(assignmentId) {
            fetch('/api/assignments/' + assignmentId + '/submissions')
                .then(function(response) { return response.json(); })
                .then(function(submissions) {
                    var submissionsSection = document.getElementById('submissions-section');
                    submissionsSection.style.display = 'block';
                    
                    var statusLabels = {
                        'clean': 'üü¢ Clean',
                        'warning': 'üü° Review',
                        'suspicious': 'üî¥ Suspicious',
                        'pending': '‚è≥ Pending'
                    };
                    
                    var html = submissions.length ? 
                        '<h3>Assignment: ' + assignmentId + '</h3>' +
                        '<p>' + submissions.length + ' submission(s)</p>' +
                        '<table><tr><th>Student</th><th>Submitted</th><th>Status</th><th>Actions</th></tr>' +
                        submissions.map(function(s) {
                            return '<tr>' +
                                '<td>' + (s.student_name || s.email) + '</td>' +
                                '<td>' + new Date(s.submitted_at).toLocaleString() + '</td>' +
                                '<td><span class="status-' + s.status + '">' + (statusLabels[s.status] || s.status) + '</span></td>' +
                                '<td><a href="/submission/' + s.id + '" class="btn btn-small">Detail</a></td>' +
                                '</tr>';
                        }).join('') + '</table>'
                        : '<p>No submissions yet.</p>';
                    
                    document.getElementById('submissions-list').innerHTML = html;
                    submissionsSection.scrollIntoView({ behavior: 'smooth' });
                });
        }
        
        function showCreateModal() {
            document.getElementById('createModal').style.display = 'flex';
            document.getElementById('success-message').style.display = 'none';
            loadSheets();
        }
        
        function hideCreateModal() {
            document.getElementById('createModal').style.display = 'none';
            document.getElementById('createForm').reset();
        }
        
        function createAssignment(event) {
            event.preventDefault();
            
            var students = parseStudents();
            if (students.length === 0) {
                alert('Please enter at least one student');
                return;
            }
            
            var patterns = document.getElementById('track_patterns').value
                .split(',')
                .map(function(s) { return s.trim(); })
                .filter(function(s) { return s; });
            
            var data = {
                name: document.getElementById('name').value,
                course: document.getElementById('course').value,
                deadline: document.getElementById('deadline').value,
                track_patterns: patterns,
                students: students
            };
            
            fetch('/api/assignments', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(function(response) { return response.json(); })
            .then(function(result) {
                var successMsg = document.getElementById('success-message');
                
                var message = '<div class="success-box">' +
                    '<strong>‚úÖ Assignment created!</strong><br>' +
                    '<p>Codes sent to ' + result.codes_sent + ' student(s)</p>';
                
                if (!result.smtp_enabled) {
                    message += '<div class="warning-box" style="margin-top: 10px;">' +
                        '<strong>‚ö†Ô∏è SMTP not configured</strong><br>' +
                        'Codes generated but not emailed.' +
                        '</div>';
                }
                
                if (result.codes_failed && result.codes_failed.length > 0) {
                    message += '<div class="warning-box" style="margin-top: 10px;">' +
                        '<strong>Failed emails:</strong><br>' +
                        result.codes_failed.map(function(f) { 
                            return f.first_name + ' ' + f.last_name + ' (' + f.email + '): <code>' + f.code + '</code>'; 
                        }).join('<br>') +
                        '</div>';
                }
                
                message += '<a href="' + result.config_url + '" class="btn btn-secondary" download style="margin-top: 10px;">' +
                    'üì• Download Config' +
                    '</a></div>';
                
                successMsg.innerHTML = message;
                successMsg.style.display = 'block';
                
                loadAssignments();
                document.getElementById('createForm').reset();
            })
            .catch(function(e) {
                alert('Error creating assignment');
                console.error(e);
            });
        }
        
        function deleteAssignment(assignmentId) {
            if (!confirm('Delete this assignment? All data will be lost!')) return;
            
            fetch('/api/assignments/' + assignmentId, {
                method: 'DELETE'
            })
            .then(function(response) {
                if (response.ok) {
                    loadAssignments();
                    document.getElementById('submissions-section').style.display = 'none';
                }
            });
        }
        
        function showSheetManager() {
            alert('Sheet manager coming soon! For now, use the API directly.');
        }
        
        // Load assignments on page load
        loadAssignments();
    </script>
</body>
</html>
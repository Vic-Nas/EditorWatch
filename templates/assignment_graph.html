<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Assignment Graph</title>
  <script type="text/javascript" src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
  <link href="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.css" rel="stylesheet" type="text/css" />
  <style>
    body { font-family: Arial, sans-serif; margin: 12px; }
    #network { width: 100%; height: 600px; border: 1px solid #ddd; }
    .legend { margin-top: 8px; }
  </style>
</head>
<body>
  <h2>Assignment Graph: {{ assignment.name }} ({{ assignment.assignment_id }})</h2>
  <p>Nodes = students. Edges = similarity above threshold (Jaccard). Click a node to see files edited.</p>

  <div id="network"></div>
  <div class="legend">
    <div style="margin-bottom:8px;">
      <strong>Node color:</strong>
      <span style="display:inline-block; width:14px; height:14px; background:#2ecc71; margin-left:8px; border:1px solid #ccc;"></span> Likely Authentic
      <span style="display:inline-block; width:14px; height:14px; background:#f39c12; margin-left:8px; border:1px solid #ccc;"></span> Needs Review
      <span style="display:inline-block; width:14px; height:14px; background:#e74c3c; margin-left:8px; border:1px solid #ccc;"></span> Suspicious
    </div>
    <label>Similarity threshold: <input id="threshold" type="range" min="0" max="1" step="0.01" value="0.5"/></label>
    <span id="thresholdValue">0.50</span>
  </div>

  <div id="info" style="margin-top:12px;"></div>

  <script>
    const data = {{ graph_data|tojson }};

    // create nodes using students so we can visualize per-student authenticity scores
    const nodes = new vis.DataSet(data.students.map(s => {
      const score = (s.overall_score !== null && s.overall_score !== undefined) ? s.overall_score : null;
      let color = '#95a5a6';
      if (score !== null) {
        color = score >= 7 ? '#2ecc71' : (score >= 4 ? '#f39c12' : '#e74c3c');
      }
      const size = score !== null ? (12 + Math.max(0, score) * 2) : 10;
      return { id: s.id, label: s.label, title: `Authenticity: ${score !== null ? score.toFixed(2) : 'N/A'}`, color, value: score, size };
    }));
    const edges = new vis.DataSet(data.edges.map(e => ({ from: e.from, to: e.to, value: e.weight })));

    const container = document.getElementById('network');
    const options = {
      nodes: { shape: 'dot', size: 16 },
      edges: { smooth: true, color: { inherit: 'from' }, width: 2 },
      physics: { stabilization: true },
      interaction: { hover: true }
    };

    const network = new vis.Network(container, { nodes, edges }, options);

    function renderInfo(studentId) {
      const s = data.students.find(x => x.id === studentId);
      if (!s) return;
      const score = (s.overall_score !== null && s.overall_score !== undefined) ? s.overall_score : null;
      const category = score === null ? 'No score' : (score >= 7 ? 'Likely Authentic' : (score >= 4 ? 'Needs Review' : 'Suspicious'));
      const el = document.getElementById('info');
      el.innerHTML = `<h3>${s.label}</h3>
        <p><strong>Authenticity:</strong> ${score !== null ? score.toFixed(2) : 'N/A'} â€” <em>${category}</em></p>
        <p><strong>Files edited (${s.files.length}):</strong></p>
        <ul>${s.files.map(f=>`<li>${f}</li>`).join('')}</ul>`;
    }

    network.on('click', function(params) {
      if (params.nodes && params.nodes.length) {
        renderInfo(params.nodes[0]);
      }
    });

    const thresholdEl = document.getElementById('threshold');
    const thresholdValue = document.getElementById('thresholdValue');
    thresholdEl.addEventListener('input', () => {
      const t = parseFloat(thresholdEl.value);
      thresholdValue.textContent = t.toFixed(2);
      // update edges
      edges.clear();
      data.edges.forEach(e => {
        if (e.weight >= t) edges.add({ from: e.from, to: e.to, value: e.weight });
      });
    });

    // initialize with default threshold
    thresholdEl.dispatchEvent(new Event('input'));
  </script>
</body>
</html>